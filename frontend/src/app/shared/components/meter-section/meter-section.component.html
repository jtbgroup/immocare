<!-- UC008 — Meter Section (shared: HOUSING_UNIT + BUILDING) -->
<section class="meter-section">
  <!-- Section header -->
  <div class="section-header">
    <h3 class="section-title">Utility Meters</h3>
  </div>

  <!-- Success / Error banners -->
  @if (successMessage) {
    <div class="alert alert-success">{{ successMessage }}</div>
  }
  @if (
    errorMessage &&
    !isAddOpen("WATER") &&
    !isAddOpen("GAS") &&
    !isAddOpen("ELECTRICITY") &&
    !isReplaceOpen("WATER") &&
    !isReplaceOpen("GAS") &&
    !isReplaceOpen("ELECTRICITY") &&
    !isRemoveOpen("WATER") &&
    !isRemoveOpen("GAS") &&
    !isRemoveOpen("ELECTRICITY")
  ) {
    <div class="alert alert-error">{{ errorMessage }}</div>
  }

  <!-- Loading -->
  @if (loading) {
    <div class="loading-placeholder">Loading meters…</div>
  }

  <!-- Type blocks -->
  @if (!loading) {
    <div class="type-blocks">
      @for (block of blocks; track block.type) {
        <div class="type-block">
          <!-- Block header -->
          <div class="type-block-header">
            <div class="type-label">
              <span class="type-label-text">{{ block.label }}</span>
            </div>
            @if (!isAddOpen(block.type)) {
              <button
                class="btn btn-sm btn-primary"
                (click)="openAddForm(block.type)"
              >
                + Add Meter
              </button>
            }
          </div>

          <!-- ── ADD FORM ──────────────────────────────────────────────── -->
          @if (isAddOpen(block.type)) {
            <div class="inline-form">
              <h4>Add {{ block.label }} Meter</h4>

              @if (errorMessage) {
                <div class="alert alert-error">{{ errorMessage }}</div>
              }

              <form [formGroup]="addForm" (ngSubmit)="submitAdd()" novalidate>
                <div class="form-group">
                  <label>Label <span class="optional">(optional)</span></label>
                  <input
                    formControlName="label"
                    type="text"
                    placeholder="e.g. Kitchen, Basement"
                  />
                  <span class="field-error">{{
                    fieldError(addForm, "label")
                  }}</span>
                </div>

                <div class="form-group">
                  <label>Meter Number <span class="required">*</span></label>
                  <input
                    formControlName="meterNumber"
                    type="text"
                    placeholder="Meter number"
                  />
                  <span class="field-error">{{
                    fieldError(addForm, "meterNumber")
                  }}</span>
                </div>

                @if (needsEan(block.type)) {
                  <div class="form-group">
                    <label>EAN Code <span class="required">*</span></label>
                    <input
                      formControlName="eanCode"
                      type="text"
                      placeholder="18-digit EAN"
                    />
                    @if (
                      addForm.get("eanCode")?.touched &&
                      !addForm.get("eanCode")?.value
                    ) {
                      <span class="field-error"
                        >EAN code is required for
                        {{ block.label | lowercase }} meters.</span
                      >
                    }
                  </div>
                }

                @if (needsInstallation(block.type)) {
                  <div class="form-group">
                    <label
                      >Installation Number
                      <span class="required">*</span></label
                    >
                    <input formControlName="installationNumber" type="text" />
                    <span class="field-error">{{
                      fieldError(addForm, "installationNumber")
                    }}</span>
                  </div>
                }

                @if (needsCustomerNumber(block.type)) {
                  <div class="form-group">
                    <label
                      >Customer Number <span class="required">*</span></label
                    >
                    <input
                      formControlName="customerNumber"
                      type="text"
                      placeholder="Customer number"
                    />
                    @if (
                      addForm.get("customerNumber")?.touched &&
                      !addForm.get("customerNumber")?.value
                    ) {
                      <span class="field-error"
                        >Customer number is required for water meters on a
                        building.</span
                      >
                    }
                  </div>
                }

                <div class="form-group">
                  <label>Start Date <span class="required">*</span></label>
                  <input formControlName="startDate" type="date" />
                  <span class="field-error">{{
                    fieldError(addForm, "startDate")
                  }}</span>
                </div>

                <div class="form-actions">
                  <button type="submit" class="btn btn-primary btn-sm">
                    Save
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary btn-sm"
                    (click)="closeAllPanels()"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          }

          <!-- ── METER LIST ─────────────────────────────────────────────── -->
          @if (!isAddOpen(block.type)) {
            <div class="meter-list">
              @if (block.meters.length === 0) {
                <p class="empty-state">
                  No {{ block.label | lowercase }} meter assigned
                </p>
              }

              @for (meter of block.meters; track meter.id) {
                <div class="meter-card">
                  <!-- ── REPLACE FORM ─────────────────────────────────── -->
                  @if (
                    isReplaceOpen(block.type) && activeMeter?.id === meter.id
                  ) {
                    <div class="inline-form">
                      <h4>Replace {{ block.label }} Meter</h4>

                      @if (errorMessage) {
                        <div class="alert alert-error">{{ errorMessage }}</div>
                      }

                      <div class="readonly-info">
                        <strong>Current:</strong>
                        @if (meter.label) {
                          <span class="meter-label-badge">{{
                            meter.label
                          }}</span>
                        }
                        {{ meter.meterNumber }}
                        @if (meter.eanCode) {
                          <span> · EAN {{ meter.eanCode }}</span>
                        }
                        @if (meter.installationNumber) {
                          <span>
                            · Install #: {{ meter.installationNumber }}</span
                          >
                        }
                        · since {{ meter.startDate }}
                      </div>

                      <form
                        [formGroup]="replaceForm"
                        (ngSubmit)="submitReplace()"
                        novalidate
                      >
                        <div class="form-group">
                          <label
                            >Label
                            <span class="optional">(optional)</span></label
                          >
                          <input
                            formControlName="newLabel"
                            type="text"
                            placeholder="e.g. Kitchen, Basement"
                          />
                        </div>

                        <div class="form-group">
                          <label
                            >New Meter Number
                            <span class="required">*</span></label
                          >
                          <input formControlName="newMeterNumber" type="text" />
                          <span class="field-error">{{
                            fieldError(replaceForm, "newMeterNumber")
                          }}</span>
                        </div>

                        @if (needsEan(block.type)) {
                          <div class="form-group">
                            <label
                              >New EAN Code
                              <span class="required">*</span></label
                            >
                            <input formControlName="newEanCode" type="text" />
                          </div>
                        }

                        @if (needsInstallation(block.type)) {
                          <div class="form-group">
                            <label
                              >New Installation Number
                              <span class="required">*</span></label
                            >
                            <input
                              formControlName="newInstallationNumber"
                              type="text"
                            />
                          </div>
                        }

                        @if (needsCustomerNumber(block.type)) {
                          <div class="form-group">
                            <label
                              >New Customer Number
                              <span class="required">*</span></label
                            >
                            <input
                              formControlName="newCustomerNumber"
                              type="text"
                            />
                          </div>
                        }

                        <div class="form-group">
                          <label
                            >New Start Date
                            <span class="required">*</span></label
                          >
                          <input formControlName="newStartDate" type="date" />
                          <span class="field-error">{{
                            fieldError(replaceForm, "newStartDate")
                          }}</span>
                        </div>

                        <div class="form-group">
                          <label
                            >Reason
                            <span class="optional">(optional)</span></label
                          >
                          <select formControlName="reason">
                            <option [ngValue]="null">
                              — Select a reason —
                            </option>
                            @for (r of ALL_REPLACEMENT_REASONS; track r) {
                              <option [value]="r">
                                {{ REPLACEMENT_REASON_LABELS[r] }}
                              </option>
                            }
                          </select>
                        </div>

                        <div class="form-actions">
                          <button type="submit" class="btn btn-primary btn-sm">
                            Confirm Replace
                          </button>
                          <button
                            type="button"
                            class="btn btn-secondary btn-sm"
                            (click)="closeAllPanels()"
                          >
                            Cancel
                          </button>
                        </div>
                      </form>
                    </div>

                    <!-- ── REMOVE DIALOG ────────────────────────────────── -->
                  } @else if (
                    isRemoveOpen(block.type) && activeMeter?.id === meter.id
                  ) {
                    <div class="inline-form remove-dialog">
                      <h4>Remove Meter</h4>
                      <p class="warning-text">
                        ⚠ You are about to close meter
                        <strong>
                          @if (meter.label) {
                            {{ meter.label }} —
                          }
                          {{ meter.meterNumber }} </strong
                        >. This action cannot be undone.
                      </p>

                      @if (errorMessage) {
                        <div class="alert alert-error">{{ errorMessage }}</div>
                      }

                      <form
                        [formGroup]="removeForm"
                        (ngSubmit)="submitRemove()"
                        novalidate
                      >
                        <div class="form-group">
                          <label
                            >End Date <span class="required">*</span></label
                          >
                          <input formControlName="endDate" type="date" />
                          <span class="field-error">{{
                            fieldError(removeForm, "endDate")
                          }}</span>
                        </div>
                        <div class="form-actions">
                          <button type="submit" class="btn btn-danger btn-sm">
                            Confirm Remove
                          </button>
                          <button
                            type="button"
                            class="btn btn-secondary btn-sm"
                            (click)="closeAllPanels()"
                          >
                            Cancel
                          </button>
                        </div>
                      </form>
                    </div>

                    <!-- ── METER CARD (normal view) ─────────────────────── -->
                  } @else {
                    <div class="meter-card-content">
                      <div class="meter-info">
                        @if (meter.label) {
                          <span class="meter-label-badge">{{
                            meter.label
                          }}</span>
                        }
                        <span class="meter-number">{{
                          meter.meterNumber
                        }}</span>
                        @if (meter.eanCode) {
                          <span class="meter-detail"
                            >EAN: {{ meter.eanCode }}</span
                          >
                        }
                        @if (meter.installationNumber) {
                          <span class="meter-detail"
                            >Install #: {{ meter.installationNumber }}</span
                          >
                        }
                        @if (meter.customerNumber) {
                          <span class="meter-detail"
                            >Customer #: {{ meter.customerNumber }}</span
                          >
                        }
                        <span class="meter-detail muted"
                          >Since {{ meter.startDate }}</span
                        >
                        <span class="meter-detail muted"
                          >{{
                            meterDurationMonths(meter.startDate)
                          }}
                          month(s)</span
                        >
                      </div>
                      <div class="meter-actions">
                        <button
                          class="btn btn-sm btn-secondary"
                          (click)="openReplaceForm(meter)"
                        >
                          Replace
                        </button>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="openRemoveDialog(meter)"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- History toggle -->
  @if (hasAnyMeter || history.length > 0) {
    <div class="history-toggle">
      <button class="btn btn-link" (click)="toggleHistory()">
        {{ showHistory ? "Hide History" : "View History" }}
      </button>
    </div>
  }

  <!-- History panel -->
  @if (showHistory) {
    <div class="history-panel">
      <div class="history-header">
        <h4>Meter History</h4>
        <button class="btn-close" (click)="toggleHistory()" title="Close">
          ✕
        </button>
      </div>
      <div class="history-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Label</th>
              <th>Meter Number</th>
              @if (ownerType === "BUILDING") {
                <th>Customer #</th>
              }
              <th>EAN / Install #</th>
              <th>Start</th>
              <th>End</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @for (h of history; track h.id) {
              <tr>
                <td>{{ METER_TYPE_LABELS[h.type] }}</td>
                <td>{{ h.label || "—" }}</td>
                <td>
                  <strong>{{ h.meterNumber }}</strong>
                </td>
                @if (ownerType === "BUILDING") {
                  <td>{{ h.customerNumber || "—" }}</td>
                }
                <td>{{ h.eanCode || h.installationNumber || "—" }}</td>
                <td>{{ h.startDate }}</td>
                <td>{{ h.endDate || "—" }}</td>
                <td>{{ meterDurationMonths(h.startDate, h.endDate) }} mo</td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="
                      h.status === 'ACTIVE' ? 'badge-green' : 'badge-gray'
                    "
                  >
                    {{ h.status }}
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</section>
