<div class="history-panel">
  <div class="history-header">
    <h4>PEB Score History</h4>
    <button class="btn-close" (click)="close.emit()">‚úï</button>
  </div>

  <!-- Improvement summary -->
  @if (improvement && improvement.history.length > 0) {
    <div class="improvement-summary">
      @if (improvement.gradesImproved > 0) {
        <span class="improved"
          >‚Üë Improved by {{ improvement.gradesImproved }} grade(s)</span
        >
        over {{ improvement.yearsCovered }} year(s) ({{
          display[improvement.firstScore].label
        }}
        ‚Üí {{ display[improvement.currentScore].label }})
      } @else if (improvement.gradesImproved < 0) {
        <span class="degraded"
          >‚Üì Degraded by {{ improvement.gradesImproved * -1 }} grade(s)</span
        >
        over {{ improvement.yearsCovered }} year(s)
      } @else {
        <span class="unchanged"
          >‚àí No change over {{ improvement.yearsCovered }} year(s)</span
        >
      }
    </div>
  }

  @if (loading) {
    <div class="loading">Loading‚Ä¶</div>
  }

  @if (!loading && history.length === 0) {
    <p class="no-data">No PEB scores recorded yet.</p>
  }

  @if (!loading && history.length > 0) {
    <table class="history-table">
      <thead>
        <tr>
          <th>Score</th>
          <th>Score Date</th>
          <th>Certificate</th>
          <th>Valid Until</th>
          <th>Status</th>
          <th>Change</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @for (item of history; track item.id) {
          <tr>
            <td>
              <span
                class="score-badge"
                [style.background]="display[item.pebScore].color"
                [style.color]="display[item.pebScore].textColor"
              >
                {{ display[item.pebScore].label }}
              </span>
            </td>
            <td>{{ item.scoreDate }}</td>
            <td>{{ item.certificateNumber ?? "‚Äî" }}</td>
            <td>{{ item.validUntil ?? "‚Äî" }}</td>
            <td>
              <span class="status-badge" [ngClass]="statusClass(item.status)">
                {{ item.status }}
              </span>
            </td>
            <td>
              <span [ngClass]="improvementClass(rowDirection(item))">
                {{ improvementIcon(rowDirection(item)) }}
              </span>
            </td>
            <td class="row-actions">
              <button
                class="icon-btn-sm"
                title="Edit"
                (click)="editRequest.emit(item)"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="icon-btn-sm icon-btn-delete"
                title="Delete"
                (click)="deleteRequest.emit(item)"
              >
                üóëÔ∏è
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }
</div>
