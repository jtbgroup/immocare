<div class="water-meter-section">
  <div class="section-header">
    <h3>Water Meter</h3>
    <button
      *ngIf="!activeMeter && !formMode"
      class="btn btn-sm btn-primary"
      (click)="openAssignForm()"
    >
      Assign Meter
    </button>
    <button
      *ngIf="activeMeter && !formMode"
      class="btn btn-sm btn-primary"
      (click)="openReplaceForm()"
    >
      Replace Meter
    </button>
  </div>

  <div *ngIf="successMessage" class="alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert-danger">{{ errorMessage }}</div>
  <div *ngIf="loading" class="loading">Loading…</div>

  <!-- Empty state -->
  <p *ngIf="!loading && !activeMeter && !formMode" class="no-data">
    No water meter assigned.
  </p>

  <!-- Meter card — même layout que peb-card -->
  <ng-container *ngIf="activeMeter && !formMode">
    <div class="meter-card">
      <div class="meter-badge">
        <span class="badge bg-success">Active</span>
      </div>
      <div class="meter-details">
        <div>
          <strong>{{ activeMeter.meterNumber }}</strong>
          <span *ngIf="activeMeter.meterLocation" class="text-muted ms-2"
            >— {{ activeMeter.meterLocation }}</span
          >
        </div>
        <div class="meter-date">
          Installed:
          <strong>{{
            activeMeter.installationDate | date: "dd/MM/yyyy"
          }}</strong>
          · Active for: {{ activeMeter.durationMonths }} months
        </div>
        <div *ngIf="isMeterOld(activeMeter)" class="badge-warning-inline">
          ⚠ Old meter — consider replacement
        </div>
      </div>
    </div>

    <!-- Actions — même style que peb-actions -->
    <div class="meter-actions">
      <button class="btn-link" (click)="toggleHistory()">
        {{ showHistory ? "Hide History" : "View History" }}
      </button>
      <span class="separator">·</span>
      <button class="btn-link danger" (click)="openRemoveForm()">Remove</button>
    </div>
  </ng-container>

  <!-- History inline — même layout que peb-history -->
  <div *ngIf="showHistory && !formMode" class="history-panel">
    <div class="history-header">
      <h4>Meter History</h4>
      <button class="btn-close" (click)="showHistory = false">✕</button>
    </div>
    <table class="history-table">
      <thead>
        <tr>
          <th>Meter Number</th>
          <th>Location</th>
          <th>Installed</th>
          <th>Removed</th>
          <th>Duration</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let m of history">
          <td>{{ m.meterNumber }}</td>
          <td>{{ m.meterLocation || "—" }}</td>
          <td>{{ m.installationDate | date: "dd/MM/yyyy" }}</td>
          <td>
            {{ m.removalDate ? (m.removalDate | date: "dd/MM/yyyy") : "—" }}
          </td>
          <td>{{ m.durationMonths }} months</td>
          <td>
            <span
              [class]="
                m.isActive
                  ? 'status-badge status-current'
                  : 'status-badge status-historical'
              "
            >
              {{ m.status }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Formulaires assign / replace / remove — inchangés -->
  <div *ngIf="formMode === 'assign'" class="meter-form-panel">
    <!-- ... conserver le form assign existant ... -->
  </div>
  <div *ngIf="formMode === 'replace'" class="meter-form-panel">
    <!-- ... conserver le form replace existant ... -->
  </div>
  <div *ngIf="formMode === 'remove'" class="meter-form-panel border-danger">
    <!-- ... conserver le form remove existant ... -->
  </div>
</div>
