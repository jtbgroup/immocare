<div class="user-form">
  <h1>{{ isEdit ? 'Edit User' : 'Create User' }}</h1>

  <div *ngIf="loading" class="loading">Loading…</div>

  <form *ngIf="!loading" [formGroup]="form" (ngSubmit)="submit()" novalidate>

    <div *ngIf="errorMessage" class="alert alert--error">{{ errorMessage }}</div>

    <!-- Username -->
    <div class="form-field">
      <label for="username">Username <span class="required">*</span></label>
      <input id="username" type="text" formControlName="username"
             [class.invalid]="form.get('username')?.invalid && form.get('username')?.touched"
             placeholder="e.g. john_doe" />
      <span class="field-error" *ngIf="fieldError('username')">{{ fieldError('username') }}</span>
    </div>

    <!-- Email -->
    <div class="form-field">
      <label for="email">Email <span class="required">*</span></label>
      <input id="email" type="email" formControlName="email"
             [class.invalid]="form.get('email')?.invalid && form.get('email')?.touched"
             placeholder="e.g. john@example.com" />
      <span class="field-error" *ngIf="fieldError('email')">{{ fieldError('email') }}</span>
    </div>

    <!-- Password fields — create mode only -->
    <ng-container *ngIf="!isEdit">
      <div class="form-field">
        <label for="password">Password <span class="required">*</span></label>
        <input id="password" type="password" formControlName="password"
               [class.invalid]="form.get('password')?.invalid && form.get('password')?.touched"
               placeholder="Min. 8 chars, 1 upper, 1 lower, 1 digit" />
        <span class="field-error" *ngIf="fieldError('password')">{{ fieldError('password') }}</span>
      </div>

      <div class="form-field">
        <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
        <input id="confirmPassword" type="password" formControlName="confirmPassword"
               [class.invalid]="(form.get('confirmPassword')?.invalid && form.get('confirmPassword')?.touched) || passwordMismatch"
               placeholder="Repeat password" />
        <span class="field-error" *ngIf="passwordMismatch">Passwords do not match</span>
        <span class="field-error" *ngIf="!passwordMismatch && fieldError('confirmPassword')">{{ fieldError('confirmPassword') }}</span>
      </div>
    </ng-container>

    <!-- Role -->
    <div class="form-field">
      <label for="role">Role <span class="required">*</span></label>
      <select id="role" formControlName="role"
              [class.invalid]="form.get('role')?.invalid && form.get('role')?.touched">
        <option *ngFor="let r of roles" [value]="r">{{ r }}</option>
      </select>
      <span class="field-error" *ngIf="fieldError('role')">{{ fieldError('role') }}</span>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn--primary" [disabled]="submitting">
        {{ submitting ? 'Saving…' : 'Save' }}
      </button>
      <button type="button" class="btn btn--secondary" (click)="cancel()">Cancel</button>
    </div>

  </form>
</div>
