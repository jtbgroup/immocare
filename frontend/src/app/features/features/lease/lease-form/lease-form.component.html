<!-- lease-form.component.html -->
<div class="container py-4" style="max-width: 860px">
  <h2 class="h4 mb-4">{{ isEditMode ? "Edit Lease" : "Create Lease" }}</h2>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border"></div>
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <form *ngIf="!isLoading" [formGroup]="form">
    <!-- Section 1: General -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">1 — General</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label"
              >Signature Date <span class="text-danger">*</span></label
            >
            <input
              type="date"
              class="form-control"
              formControlName="signatureDate"
              [class.is-invalid]="isInvalid('signatureDate')"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >Start Date <span class="text-danger">*</span></label
            >
            <input
              type="date"
              class="form-control"
              formControlName="startDate"
              [class.is-invalid]="isInvalid('startDate')"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">End Date (computed)</label>
            <input
              type="date"
              class="form-control"
              [value]="computedEndDate"
              readonly
              style="background: #f8f9fa"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >Lease Type <span class="text-danger">*</span></label
            >
            <select class="form-select" formControlName="leaseType">
              <option *ngFor="let t of LEASE_TYPES" [value]="t">
                {{ LEASE_TYPE_LABELS[t] }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >Duration (months) <span class="text-danger">*</span></label
            >
            <input
              type="number"
              class="form-control"
              formControlName="durationMonths"
              min="1"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >Notice Period (months) <span class="text-danger">*</span></label
            >
            <input
              type="number"
              class="form-control"
              formControlName="noticePeriodMonths"
              min="1"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 2: Financial -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">2 — Financial</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label"
              >Monthly Rent (€) <span class="text-danger">*</span></label
            >
            <input
              type="number"
              class="form-control"
              formControlName="monthlyRent"
              min="0.01"
              step="0.01"
              [class.is-invalid]="isInvalid('monthlyRent')"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Monthly Charges (€)</label>
            <input
              type="number"
              class="form-control"
              formControlName="monthlyCharges"
              min="0"
              step="0.01"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Charges Type</label>
            <select class="form-select" formControlName="chargesType">
              <option value="FORFAIT">Forfait</option>
              <option value="PROVISION">Provision</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Charges Description</label>
            <input
              type="text"
              class="form-control"
              formControlName="chargesDescription"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 3: Indexation -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">3 — Indexation</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Base Index Value</label>
            <input
              type="number"
              class="form-control"
              formControlName="baseIndexValue"
              step="0.0001"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Base Index Month</label>
            <input
              type="month"
              class="form-control"
              formControlName="baseIndexMonth"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label">Anniversary Month</label>
            <select
              class="form-select"
              formControlName="indexationAnniversaryMonth"
            >
              <option [value]="null">—</option>
              <option
                *ngFor="let m of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]"
                [value]="m"
              >
                {{ m }}
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Notice (days)</label>
            <input
              type="number"
              class="form-control"
              formControlName="indexationNoticeDays"
              min="0"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: Registration -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">4 — Registration</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">SPF Finances Number</label>
            <input
              type="text"
              class="form-control"
              formControlName="registrationSpf"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label">Region Number</label>
            <input
              type="text"
              class="form-control"
              formControlName="registrationRegion"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 5: Deposit -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">5 — Guarantee / Deposit</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Deposit Amount (€)</label>
            <input
              type="number"
              class="form-control"
              formControlName="depositAmount"
              min="0"
              step="0.01"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Deposit Type</label>
            <select class="form-select" formControlName="depositType">
              <option [value]="null">—</option>
              <option value="BLOCKED_ACCOUNT">Blocked Account</option>
              <option value="BANK_GUARANTEE">Bank Guarantee</option>
              <option value="CPAS">CPAS</option>
              <option value="INSURANCE">Insurance</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Deposit Reference</label>
            <input
              type="text"
              class="form-control"
              formControlName="depositReference"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 6: Insurance -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">6 — Tenant Insurance</div>
      <div class="card-body">
        <div class="form-check mb-3">
          <input
            class="form-check-input"
            type="checkbox"
            formControlName="tenantInsuranceConfirmed"
            id="insuranceCheck"
          />
          <label class="form-check-label" for="insuranceCheck"
            >Insurance confirmed</label
          >
        </div>
        <div *ngIf="showInsuranceDetails" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Policy Reference</label>
            <input
              type="text"
              class="form-control"
              formControlName="tenantInsuranceReference"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Expiry Date</label>
            <input
              type="date"
              class="form-control"
              formControlName="tenantInsuranceExpiry"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Section 7: Tenants -->
    <div class="card shadow-sm mb-4">
      <div class="card-header fw-semibold">7 — Tenants</div>
      <div class="card-body">
        <!-- Current tenants -->
        <div
          *ngFor="let t of pendingTenants; let i = index"
          class="d-flex align-items-center gap-3 mb-2 p-2 border rounded"
        >
          <span class="fw-semibold"
            >{{ t.person.lastName }} {{ t.person.firstName }}</span
          >
          <select
            class="form-select form-select-sm w-auto"
            [(ngModel)]="t.role"
            [ngModelOptions]="{ standalone: true }"
          >
            <option value="PRIMARY">Primary</option>
            <option value="CO_TENANT">Co-Tenant</option>
            <option value="GUARANTOR">Guarantor</option>
          </select>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger ms-auto"
            (click)="removeTenantFromForm(i)"
          >
            ✕
          </button>
        </div>
        <div *ngIf="!hasPrimaryTenant()" class="text-danger small mb-2">
          At least one PRIMARY tenant is required.
        </div>
        <!-- Person Picker to add -->
        <app-person-picker
          label="Add Tenant"
          [required]="false"
          (personSelected)="addTenantToForm($event)"
        ></app-person-picker>
      </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 flex-wrap">
      <button
        type="button"
        class="btn btn-outline-primary"
        (click)="saveAsDraft()"
        [disabled]="isSaving"
      >
        <span
          *ngIf="isSaving"
          class="spinner-border spinner-border-sm me-1"
        ></span>
        Save as Draft
      </button>
      <button
        *ngIf="!isEditMode"
        type="button"
        class="btn btn-primary"
        (click)="saveAndActivate()"
        [disabled]="isSaving"
      >
        Save &amp; Activate
      </button>
      <button
        *ngIf="isEditMode"
        type="button"
        class="btn btn-primary"
        (click)="saveAsDraft()"
        [disabled]="isSaving"
      >
        Save Changes
      </button>
      <button type="button" class="btn btn-secondary" (click)="cancel()">
        Cancel
      </button>
    </div>
  </form>
</div>
