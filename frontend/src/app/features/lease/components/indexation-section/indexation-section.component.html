<!-- features/lease/indexation-section/indexation-section.component.html -->
<div class="info-card">
  <div class="info-card-title">
    <h2>Indexation</h2>
    <button
      *ngIf="lease.status === 'ACTIVE'"
      class="btn btn-primary btn-sm"
      (click)="showForm = !showForm"
    >
      {{ showForm ? "Cancel" : "Record Indexation" }}
    </button>
  </div>

  <!-- Base index info -->
  <div *ngIf="lease.baseIndexValue" class="base-index-info">
    <span
      >Base index: <strong>{{ lease.baseIndexValue }}</strong> ({{
        lease.baseIndexMonth | date: "MMM yyyy"
      }})</span
    >
    <span *ngIf="lease.indexationAnniversaryMonth"
      >Anniversary:
      <strong>month {{ lease.indexationAnniversaryMonth }}</strong></span
    >
  </div>

  <!-- Record form -->
  <div *ngIf="showForm" class="picker-panel">
    <div *ngIf="formError" class="alert alert-error">{{ formError }}</div>

    <div class="form-row form-row-3">
      <div class="form-group">
        <label>Application Date <span class="required">*</span></label>
        <input type="date" [(ngModel)]="req.applicationDate" />
      </div>
      <div class="form-group">
        <label>Old Rent</label>
        <input type="number" [value]="lease.monthlyRent" readonly />
      </div>
      <div class="form-group">
        <label>New Index <span class="required">*</span></label>
        <input type="number" [(ngModel)]="req.newIndexValue" step="0.0001" />
      </div>
    </div>
    <div class="form-row form-row-3">
      <div class="form-group">
        <label>Index Month <span class="required">*</span></label>
        <input type="month" [(ngModel)]="req.newIndexMonth" />
      </div>
      <div class="form-group">
        <label>Applied Rent (€) <span class="required">*</span></label>
        <input type="number" [(ngModel)]="req.appliedRent" step="0.01" />
      </div>
      <div class="form-group">
        <label>Notification Date</label>
        <input type="date" [(ngModel)]="req.notificationSentDate" />
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <input type="text" [(ngModel)]="req.notes" />
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" (click)="showForm = false">
        Cancel
      </button>
      <button class="btn btn-primary" (click)="save()" [disabled]="isSaving">
        {{ isSaving ? "Saving…" : "Save" }}
      </button>
    </div>
  </div>

  <!-- History table -->
  <div
    *ngIf="lease.indexations && lease.indexations.length > 0"
    class="data-table"
  >
    <table>
      <thead>
        <tr>
          <th>Application Date</th>
          <th>Old Rent</th>
          <th>Index Value</th>
          <th>Applied Rent</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let idx of lease.indexations">
          <td>{{ idx.applicationDate | date: "dd/MM/yyyy" }}</td>
          <td>{{ idx.oldRent | currency: "EUR" : "symbol" : "1.2-2" }}</td>
          <td>{{ idx.newIndexValue }}</td>
          <td>
            <strong>{{
              idx.appliedRent | currency: "EUR" : "symbol" : "1.2-2"
            }}</strong>
          </td>
          <td>{{ idx.notes || "—" }}</td>
        </tr>
      </tbody>
    </table>
    <p class="total-change">
      Total change since start:
      {{ totalChange | currency: "EUR" : "symbol" : "1.2-2" }} ({{
        totalChangePct | number: "1.1-1"
      }}%)
    </p>
  </div>

  <p
    *ngIf="!lease.indexations || lease.indexations.length === 0"
    class="empty-message"
  >
    No indexations recorded yet.
  </p>
</div>
